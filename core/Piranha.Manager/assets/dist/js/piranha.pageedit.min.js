piranha.pageedit=new Vue({el:"#pageedit",data:{loading:!0,id:null,siteId:null,parentId:null,originalId:null,sortOrder:0,typeId:null,title:null,navigationTitle:null,slug:null,metaTitle:null,metaKeywords:null,metaDescription:null,metaIndex:null,metaFollow:null,metaPriority:null,ogTitle:null,ogDescription:null,ogImage:{id:null,media:null},excerpt:null,isHidden:!1,published:null,publishedTime:null,redirectUrl:null,redirectType:null,enableComments:null,closeCommentsAfterDays:null,commentCount:null,pendingCommentCount:0,state:"new",editorialStatus:null,availableTransitions:[],blocks:[],regions:[],editors:[],useBlocks:!0,usePrimaryImage:!0,useExcerpt:!0,useHtmlExcerpt:!0,permissions:[],primaryImage:{id:null,media:null},selectedPermissions:[],workflowStageName:null,isCopy:!1,isScheduled:!1,saving:!1,savingDraft:!1,selectedRegion:{uid:"uid-blocks",name:null,icon:null},selectedSetting:"uid-settings",selectedRoute:null,routes:[]},computed:{contentRegions:function(){return this.regions.filter(function(e){return"setting"!=e.meta.display&&"hidden"!=e.meta.display})},settingRegions:function(){return this.regions.filter(function(e){return"setting"===e.meta.display})},primaryImageUrl:function(){return null!=this.primaryImage.media?piranha.utils.formatUrl("~/manager/api/media/url/"+this.primaryImage.id+"/448/200"):piranha.utils.formatUrl("~/manager/assets/img/empty-image.png")},isExcerptEmpty:function(){return piranha.utils.isEmptyText(this.excerpt)},metaPriorityDescription:function(){var e=piranha.resources.texts.important;return this.metaPriority<=.3?e=piranha.resources.texts.low:this.metaPriority<=.6?e=piranha.resources.texts.medium:this.metaPriority<=.9&&(e=piranha.resources.texts.high),e+(" ("+this.metaPriority)+")"}},mounted(){document.addEventListener("keydown",this.doHotKeys)},beforeDestroy(){document.removeEventListener("keydown",this.doHotKeys)},methods:{bind:function(e){this.id=e.id,this.siteId=e.siteId,this.parentId=e.parentId,this.originalId=e.originalId,this.sortOrder=e.sortOrder,this.typeId=e.typeId,this.title=e.title,this.navigationTitle=e.navigationTitle,this.slug=e.slug,this.metaTitle=e.metaTitle,this.metaKeywords=e.metaKeywords,this.metaDescription=e.metaDescription,this.metaIndex=e.metaIndex,this.metaFollow=e.metaFollow,this.metaPriority=e.metaPriority,this.ogTitle=e.ogTitle,this.ogDescription=e.ogDescription,this.ogImage=e.ogImage,this.excerpt=e.excerpt,this.isHidden=e.isHidden,this.published=e.published,this.publishedTime=e.publishedTime,this.redirectUrl=e.redirectUrl,this.redirectType=e.redirectType,this.enableComments=e.enableComments,this.closeCommentsAfterDays=e.closeCommentsAfterDays,this.commentCount=e.commentCount,this.pendingCommentCount=e.pendingCommentCount,this.state=e.state,this.editorialStatus=e.editorialStatus,this.availableTransitions=[],this.loadTransitions(),this.blocks=e.blocks,this.regions=e.regions,this.editors=e.editors,this.useBlocks=e.useBlocks,this.usePrimaryImage=e.usePrimaryImage,this.useExcerpt=e.useExcerpt,this.useHtmlExcerpt=e.useHtmlExcerpt,this.isCopy=e.isCopy,this.isScheduled=e.isScheduled,this.selectedRoute=e.selectedRoute,this.routes=e.routes,this.permissions=e.permissions,this.primaryImage=e.primaryImage,this.selectedPermissions=e.selectedPermissions,this.workflowStageName=e.workflowStageName,this.useBlocks?this.selectedRegion={uid:"uid-blocks",name:null,icon:null}:0<this.editors.length?this.selectedRegion=this.editors[0]:0<this.contentRegions.length&&(this.selectedRegion=this.contentRegions[0].meta)},load:function(e){var t=this;fetch(piranha.baseUrl+"manager/api/page/"+e).then(function(e){return e.json()}).then(function(e){t.bind(e)}).catch(function(e){console.log("error:",e)})},create:function(e,t){var i=this;fetch(piranha.baseUrl+"manager/api/page/create/"+e+"/"+t).then(function(e){return e.json()}).then(function(e){i.bind(e)}).catch(function(e){console.log("error:",e)})},createrelative:function(e,t,i){var n=this;fetch(piranha.baseUrl+"manager/api/page/createrelative/"+e+"/"+t+"/"+i).then(function(e){return e.json()}).then(function(e){n.bind(e)}).catch(function(e){console.log("error:",e)})},copy:function(e,t){var i=this;fetch(piranha.baseUrl+"manager/api/page/copy/"+e+"/"+t).then(function(e){return e.json()}).then(function(e){i.bind(e)}).catch(function(e){console.log("error:",e)})},copyrelative:function(e,t,i){var n=this;fetch(piranha.baseUrl+"manager/api/page/copyrelative/"+e+"/"+t+"/"+i).then(function(e){return e.json()}).then(function(e){n.bind(e)}).catch(function(e){console.log("error:",e)})},doHotKeys(e){83===e.keyCode&&e.ctrlKey&&(e.preventDefault(),this.saveDraft())},save:function(){this.saving=!0,this.saveInternal(piranha.baseUrl+"manager/api/page/save")},saveDraft:function(){this.savingDraft=!0,this.saveInternal(piranha.baseUrl+"manager/api/page/save/draft")},unpublish:function(){this.saving=!0,this.saveInternal(piranha.baseUrl+"manager/api/page/save/unpublish")},saveInternal:function(e){var i=this,t={id:i.id,siteId:i.siteId,parentId:i.parentId,originalId:i.originalId,sortOrder:i.sortOrder,typeId:i.typeId,title:i.title,navigationTitle:i.navigationTitle,slug:i.slug,metaTitle:i.metaTitle,metaKeywords:i.metaKeywords,metaDescription:i.metaDescription,metaIndex:i.metaIndex,metaFollow:i.metaFollow,metaPriority:i.metaPriority,ogTitle:i.ogTitle,ogDescription:i.ogDescription,ogImage:{id:i.ogImage.id},excerpt:i.excerpt,isHidden:i.isHidden,published:i.published,publishedTime:i.publishedTime,redirectUrl:i.redirectUrl,redirectType:i.redirectType,enableComments:i.enableComments,closeCommentsAfterDays:i.closeCommentsAfterDays,isCopy:i.isCopy,blocks:JSON.parse(JSON.stringify(i.blocks)),regions:JSON.parse(JSON.stringify(i.regions)),selectedRoute:i.selectedRoute,selectedPermissions:i.selectedPermissions,workflowStageName:i.workflowStageName,primaryImage:{id:i.primaryImage.id}};fetch(e,{method:"post",headers:piranha.utils.antiForgeryHeaders(),body:JSON.stringify(t)}).then(function(e){return e.json()}).then(function(e){var t=i.state;i.id=e.id,i.slug=e.slug,i.published=e.published,i.publishedTime=e.publishedTime,i.state=e.state,i.isCopy=e.isCopy,i.selectedRoute=e.selectedRoute,"new"===t&&"new"!==e.state&&(window.history.replaceState({state:"created"},"Edit page",piranha.baseUrl+"manager/page/edit/"+e.id),setTimeout(()=>window.location.reload(),1)),piranha.notifications.push(e.status),i.saving=!1,i.savingDraft=!1,i.eventBus.$emit("onSaved",i.state)}).catch(function(e){console.log("error:",e)})},revert:function(){var t=this;fetch(piranha.baseUrl+"manager/api/page/revert",{method:"post",headers:piranha.utils.antiForgeryHeaders(),body:JSON.stringify(t.id)}).then(function(e){return e.json()}).then(function(e){t.bind(e),piranha.notifications.push(e.status)}).catch(function(e){console.log("error:",e)})},detach:function(){var t=this;fetch(piranha.baseUrl+"manager/api/page/detach",{method:"post",headers:piranha.utils.antiForgeryHeaders(),body:JSON.stringify(t.id)}).then(function(e){return e.json()}).then(function(e){t.bind(e),piranha.notifications.push(e.status)}).catch(function(e){console.log("error:",e)})},remove:function(){var e=this;piranha.alert.open({title:piranha.resources.texts.delete,body:piranha.resources.texts.deletePageConfirm,confirmCss:"btn-danger",confirmIcon:"fas fa-trash",confirmText:piranha.resources.texts.delete,onConfirm:function(){fetch(piranha.baseUrl+"manager/api/page/delete",{method:"delete",headers:piranha.utils.antiForgeryHeaders(),body:JSON.stringify(e.id)}).then(function(e){return e.json()}).then(function(e){piranha.notifications.push(e),window.location=piranha.baseUrl+"manager/pages"}).catch(function(e){console.log("error:",e)})}})},addBlock:function(e,t){fetch(piranha.baseUrl+"manager/api/content/block/"+e).then(function(e){return e.json()}).then(function(e){piranha.pageedit.blocks.splice(t,0,e.body)}).catch(function(e){console.log("error:",e)})},moveBlock:function(e,t){this.blocks.splice(t,0,this.blocks.splice(e,1)[0])},collapseBlock:function(e){e.meta.isCollapsed=!e.meta.isCollapsed},removeBlock:function(e){e=this.blocks.indexOf(e);-1!==e&&this.blocks.splice(e,1)},updateBlockTitle:function(e){for(var t=0;t<this.blocks.length;t++)if(this.blocks[t].meta.uid===e.uid){this.blocks[t].meta.title=e.title;break}},selectRegion:function(e){this.selectedRegion=e,Vue.nextTick(function(){piranha.editor.refreshMarkdown()})},selectSetting:function(e){this.selectedSetting=e,Vue.nextTick(function(){piranha.editor.refreshMarkdown()})},isCommentsOpen:function(){return new Date(this.published+" "+this.publishedTime).addDays(this.closeCommentsAfterDays)>new Date},commentsClosedDate:function(){return new Date(this.published+" "+this.publishedTime).addDays(this.closeCommentsAfterDays).toDateString()},selectPrimaryImage:function(){null!==this.primaryImage.media?piranha.mediapicker.open(this.updatePrimaryImage,"Image",this.primaryImage.media.folderId):piranha.mediapicker.openCurrentFolder(this.updatePrimaryImage,"Image")},removePrimaryImage:function(){this.primaryImage.id=null,this.primaryImage.media=null},updatePrimaryImage:function(e){"Image"===e.type?(this.primaryImage.id=e.id,this.primaryImage.media=e):console.log("No image was selected")},onExcerptBlur:function(e){this.useHtmlExcerpt?this.excerpt=tinyMCE.activeEditor.getContent():this.excerpt=e.target.innerHTML},submitToEditorial:function(){var t=this;fetch(piranha.baseUrl+"manager/api/page/"+t.id+"/submit",{method:"post",headers:piranha.utils.antiForgeryHeaders()}).then(function(e){return e.json()}).then(function(e){piranha.notifications.push({type:"success",body:"Submetido para revisão editorial.",timeout:4e3}),t.editorialStatus=e.status}).catch(function(e){console.error("Erro ao submeter para revis�o:",e)})},loadTransitions:function(){var t=this;fetch(piranha.baseUrl+"manager/api/page/available-transitions/"+t.id).then(function(e){return e.json()}).then(function(e){t.availableTransitions=e}).catch(function(e){console.error("Erro ao carregar transi��es dispon�veis:",e)})},applyTransition:function(e){var t=this;fetch(piranha.baseUrl+"manager/api/page/transition/"+t.id,{method:"post",headers:{...piranha.utils.antiForgeryHeaders(),"Content-Type":"application/json"},body:JSON.stringify({toStatus:e.toStatus})}).then(function(e){if(e.ok)return e.json();throw new Error("Erro ao aplicar transi��o")}).then(function(e){t.editorialStatus=e.status,t.loadTransitions(),piranha.notifications.push({type:"success",body:"Transi��o realizada com sucesso.",timeout:300}),setTimeout(()=>window.location.reload(),1)}).catch(function(e){console.error("Erro ao aplicar transi��o:",e),piranha.notifications.push({type:"danger",body:"Erro ao aplicar transi��o.",timeout:4e3})})},getButtonClass:function(e){switch(e.toLowerCase()){case"submeter para revis�o":case"submeter":return"btn-warning";case"aprovar":return"btn-success";case"rejeitar":return"btn-danger";case"publicar":return"btn-success";case"voltar ao rascunho":return"btn-secondary";default:return"btn-info"}},getButtonIcon:function(e){switch(e.toLowerCase()){case"submeter para revis�o":case"submeter":return"fas fa-paper-plane";case"aprovar":return"fas fa-check";case"rejeitar":return"fas fa-times";case"publicar":return"fas fa-bullhorn";case"voltar ao rascunho":return"fas fa-pencil-alt";default:return"fas fa-random"}},performTransition:function(e){this.applyTransition(e)}},created:function(){},updated:function(){this.loading?(sortable("#content-blocks",{handle:".handle",items:":not(.unsortable)"})[0].addEventListener("sortupdate",function(e){piranha.pageedit.moveBlock(e.detail.origin.index,e.detail.destination.index)}),piranha.editor.addInline("excerpt-body","excerpt-toolbar")):(sortable("#content-blocks","disable"),sortable("#content-blocks","enable")),this.loading=!1},components:{datepicker:vuejsDatepicker}});